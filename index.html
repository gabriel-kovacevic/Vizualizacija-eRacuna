<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TEST Vizualizacija</title>

  <style>
    body {
      font-family: 'EON Brix Sans Regular', sans-serif;
      background: #f8f5f2;
      margin: 0;
      max-width: 100vw;
    }

    h1 {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .header {
      display: flex;
      justify-content: space-between;
      background-color: #ea1b0a;
      color: #f8f5f2;
    }

    .header h1 {
      margin: 1rem 2rem;
      font-size: 2.5rem;
    }

    .contact {
      margin: 1rem 2rem;
      text-align: right;
      font-size: 1rem;
    }

    .content {
      padding: 2rem;
      display: flex;
      gap: 2rem;
    }

    .controls button {
      background: #27a9ff;
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
    }

    .result {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      padding: 2rem;
    }

    .card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      flex: 1 1 600px;
      display: flex;
      flex-direction: column;
    }

    .card-header {
      padding: .5rem 1rem;
      background: #d7d0cc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    iframe {
      width: 100%;
      height: 700px;
      border: none;
    }
  </style>
</head>

<body>

<div class="header">
  <h1>TEST Vizualizacija eRačuna</h1>
  <div class="contact">
    <strong>Stranicu izradili:</strong><br>
    Matej Peričić<br>
    Gabriel Kovačević
  </div>
</div>

<div class="content">
  <div>
    <p>Select one or more XML files:</p>
    <input type="file" id="xmlFiles" accept=".xml" multiple />
    <div class="controls">
      <button id="printAll" disabled>Print All as PDF</button>
      <button id="exportAll" disabled>Export All as HTML</button>
    </div>
  </div>
</div>

<div class="result" id="result"></div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
/* ================================
   GLOBAL STATE
================================ */
const input = document.getElementById("xmlFiles");
const result = document.getElementById("result");
const printAllBtn = document.getElementById("printAll");
const exportAllBtn = document.getElementById("exportAll");

let xslDoc = null;
let xslReady = false;
let renderedDocs = [];

/* ================================
   LOAD XSL (BLOCK UNTIL READY)
================================ */
fetch("invoice-sap.xsl")
  .then(r => r.text())
  .then(txt => {
    const parser = new DOMParser();
    xslDoc = parser.parseFromString(txt, "application/xml");

    if (xslDoc.getElementsByTagName("parsererror").length) {
      throw new Error("Invalid XSL");
    }

    xslReady = true;
    console.log("XSL loaded");
  })
  .catch(err => {
    alert("Failed to load XSL");
    console.error(err);
  });

/* ================================
   FILE INPUT HANDLER
================================ */
input.addEventListener("change", async e => {

  if (!xslReady) {
    alert("XSL još nije učitan. Pokušajte ponovno.");
    input.value = "";
    return;
  }

  result.innerHTML = "";
  renderedDocs = [];
  printAllBtn.disabled = true;
  exportAllBtn.disabled = true;

  const parser = new DOMParser();

  for (const file of e.target.files) {

    const xmlText = await file.text();
    const xmlDoc = parser.parseFromString(xmlText, "application/xml");

    if (xmlDoc.getElementsByTagName("parsererror").length) {
      console.error("XML parse error:", file.name);
      continue;
    }

    const proc = new XSLTProcessor();
    proc.importStylesheet(xslDoc);

    const transformed = proc.transformToDocument(xmlDoc);

    if (!transformed || !transformed.documentElement) {
      console.error("XSLT failed:", file.name);
      continue;
    }

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="card-header">
        <span>${file.name}</span>
        <button>Print as PDF</button>
      </div>
    `;

    const iframe = document.createElement("iframe");
    card.appendChild(iframe);
    result.appendChild(card);

    const doc = iframe.contentDocument;
    doc.open();
    doc.write("<!DOCTYPE html><html>");
    doc.write(transformed.documentElement.innerHTML);
    doc.write("</html>");
    doc.close();

    card.querySelector("button").onclick = () => {
      iframe.contentWindow.focus();
      iframe.contentWindow.print();
    };

    renderedDocs.push({ iframe, filename: file.name });
  }

  if (renderedDocs.length) {
    printAllBtn.disabled = false;
    exportAllBtn.disabled = false;
  }
});

/* ================================
   PRINT ALL
================================ */
printAllBtn.onclick = async () => {
  for (const { iframe } of renderedDocs) {
    iframe.contentWindow.focus();
    iframe.contentWindow.print();
    await new Promise(r => setTimeout(r, 800));
  }
};

/* ================================
   EXPORT ALL HTML
================================ */
exportAllBtn.onclick = async () => {
  const zip = new JSZip();

  for (const { iframe, filename } of renderedDocs) {
    const html = "<!DOCTYPE html>\n" +
      iframe.contentDocument.documentElement.outerHTML;
    zip.file(filename.replace(/\.xml$/i, ".html"), html);
  }

  const blob = await zip.generateAsync({ type: "blob" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "invoices.zip";
  a.click();
};

/* ================================
   ATTACHMENT HANDLING (STRICT)
================================ */
const ALLOWED_MIME_TYPES = {
  "application/pdf": "pdf",
  "image/png": "png",
  "image/jpeg": "jpg",
  "text/csv": "csv",
  "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet": "xlsx",
  "application/vnd.oasis.opendocument.spreadsheet": "ods"
};

window.addEventListener("message", e => {
  if (!e.data || e.data.type !== "ATTACHMENT") return;

  const { base64, mime, name } = e.data;

  if (!ALLOWED_MIME_TYPES[mime]) {
    alert("Nepodržan tip privitka:\n" + mime);
    return;
  }

  const bytes = atob(base64);
  const arr = Uint8Array.from(bytes, c => c.charCodeAt(0));
  const blob = new Blob([arr], { type: mime });
  const url = URL.createObjectURL(blob);

  if (mime === "application/pdf" || mime.startsWith("image/")) {
    window.open(url, "_blank");
  } else {
    const a = document.createElement("a");
    a.href = url;
    a.download = `${name}.${ALLOWED_MIME_TYPES[mime]}`;
    a.click();
  }

  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
